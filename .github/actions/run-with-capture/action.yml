name: 'Run Command with Exit Code Capture'
description: 'Runs a command, captures exit code and error messages, always exits successfully'
inputs:
  command:
    description: 'Command to execute'
    required: true
  step_name:
    description: 'Name of the step for error reporting'
    required: true

outputs:
  outcome:
    description: 'success or failure'
    value: ${{ steps.run-command.outputs.outcome }}
  error_message:
    description: 'Error message if command failed'
    value: ${{ steps.run-command.outputs.error_message }}

runs:
  using: "composite"
  steps:
    - name: Run wrapped command
      id: run-command
      shell: bash
      env:
        COMMAND: ${{ inputs.command }}
        STEP_NAME: ${{ inputs.step_name }}
      run: |
        set +e

        echo "ðŸ”„ Running: $STEP_NAME"

        # Execute the command and capture output
        ERROR_OUTPUT=$(eval "$COMMAND" 2>&1)
        EXIT_CODE=$?

        set -e

        # Always show output (for visibility in logs)
        echo "$ERROR_OUTPUT"

        if [ $EXIT_CODE -ne 0 ]; then
          echo "outcome=failure" >> $GITHUB_OUTPUT
          # Extract error message (look for lines with âŒ, or use generic message)
          ERROR_MSG=$(echo "$ERROR_OUTPUT" | grep "âŒ" | tail -1 | sed 's/âŒ //' || echo "Command failed")
          echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
        else
          echo "outcome=success" >> $GITHUB_OUTPUT
          echo "error_message=" >> $GITHUB_OUTPUT
        fi

        # Always exit successfully - don't fail the step
        exit 0
