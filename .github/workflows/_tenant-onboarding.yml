name: "_Tenant Onboarding"

on:
  workflow_call:
    inputs:
      tenant:
        description: 'Tenant name'
        required: true
        type: string
      dry_run:
        description: 'Dry run mode (validation only, no deployment)'
        type: boolean
        default: false
    outputs:
      validation_status:
        description: 'Configuration validation status'
        value: ${{ jobs.validate-config.outputs.status }}
      amplify_status:
        description: 'Amplify initialization status'
        value: ${{ jobs.amplify-init.outputs.status }}
      portal_status:
        description: 'Portal deployment status'
        value: ${{ jobs.deploy-portal.outputs.status }}
      pos_status:
        description: 'POS deployment status'
        value: ${{ jobs.deploy-pos.outputs.status }}

permissions:
  contents: write  # For creating GitHub releases (desktop)
  id-token: write  # For AWS OIDC

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: VALIDATE CONFIGURATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-config:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment: ${{ inputs.tenant }}
    outputs:
      status: ${{ steps.final_status.outputs.status }}

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      INSTALLER_PUBLISHER: ${{ vars.INSTALLER_PUBLISHER }}
      INSTALLER_APP_NAME: ${{ vars.INSTALLER_APP_NAME }}
      INSTALLER_SUPPORT_URL: ${{ vars.INSTALLER_SUPPORT_URL }}
      AWS_IAM_ROLE_ARN: ${{ vars.AWS_IAM_ROLE_ARN }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      BASE_URL: ${{ vars.BASE_URL }}
      TENANT_NAME: ${{ vars.TENANT_NAME }}
      COGNITO_POOL_ID: ${{ secrets.COGNITO_POOL_ID }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate tenant configuration
        id: validate
        run: bash .github/scripts/tenants/validate_config.sh "${{ inputs.tenant }}" "onboarding"

      - name: Save validation status
        if: always()
        uses: ./.github/actions/save-tenant-status
        with:
          tenant: ${{ inputs.tenant }}
          phase: 'validation'
          status: ${{ steps.validate.outcome == 'success' && 'success' || 'failed' }}
          error: ${{ steps.validate.outcome != 'success' && 'Configuration validation failed' || '' }}
          config_snapshot: |
            {
              "AWS_REGION": "${{ env.AWS_REGION }}",
              "BASE_URL": "${{ env.BASE_URL }}",
              "TENANT_NAME": "${{ env.TENANT_NAME }}"
            }

      - name: Set final status for job output
        if: always()
        id: final_status
        run: echo "status=${{ steps.validate.outcome == 'success' && 'success' || 'failed' }}" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: AMPLIFY INITIALIZATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  amplify-init:
    name: Amplify Init
    runs-on: ubuntu-latest
    needs: validate-config
    if: inputs.dry_run != true && needs.validate-config.outputs.status == 'success'
    timeout-minutes: 15
    environment: ${{ inputs.tenant }}
    outputs:
      status: ${{ steps.final_status.outputs.status }}
      amplify_app_id: ${{ steps.init_amplify.outputs.AMPLIFY_APP_ID }}

    env:
      ENV_NAME: dev
      AWS_REGION: ${{ vars.AWS_REGION }}
      BASE_URL: ${{ vars.BASE_URL }}
      TENANT_NAME: ${{ vars.TENANT_NAME }}
      AMPLIFY_APP_ID: ${{ secrets.AMPLIFY_APP_ID }}
      COGNITO_POOL_ID: ${{ secrets.COGNITO_POOL_ID }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Amplify CLI
        id: install_amplify_cli
        shell: bash
        run: bash .github/scripts/shared/install_amplify_cli.sh

      - name: Configure AWS Credentials (OIDC)
        if: steps.install_amplify_cli.outcome == 'success'
        id: configure_aws
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Initialize Amplify Stack
        if: steps.configure_aws.outcome == 'success'
        id: init_amplify
        shell: bash
        run: bash .github/scripts/tenants/init_amplify_stack.sh

      - name: Create AMPLIFY_APP_ID Secret
        if: steps.init_amplify.outcome == 'success' && steps.init_amplify.outputs.AMPLIFY_APP_ID != ''
        id: create_secret
        shell: bash
        run: |
          AMPLIFY_APP_ID="${{ steps.init_amplify.outputs.AMPLIFY_APP_ID }}"

          echo "ðŸ” Saving AMPLIFY_APP_ID secret to ${{ inputs.tenant }} environment..."
          echo "App ID: $AMPLIFY_APP_ID"

          gh secret set AMPLIFY_APP_ID \
            --body "$AMPLIFY_APP_ID" \
            --env "${{ inputs.tenant }}" \
            --repo "${{ github.repository }}"

          echo "âœ… AMPLIFY_APP_ID secret saved successfully"

      - name: Import Cognito Authentication
        if: steps.init_amplify.outcome == 'success'
        id: import_auth
        shell: bash
        run: bash .github/scripts/tenants/import_cognito_auth.sh

      - name: Create Amplify Branch
        if: steps.import_auth.outcome == 'success'
        id: create_amplify_branch
        env:
          AMPLIFY_APP_ID: ${{ steps.init_amplify.outputs.AMPLIFY_APP_ID }}
          BRANCH_NAME: dev
        shell: bash
        run: bash .github/scripts/tenants/create_amplify_branch.sh

      - name: Configure Rewrites & Redirects
        if: steps.create_amplify_branch.outcome == 'success'
        id: configure_rewrites
        env:
          AMPLIFY_APP_ID: ${{ steps.init_amplify.outputs.AMPLIFY_APP_ID }}
        shell: bash
        run: bash .github/scripts/tenants/configure_amplify_rewrites.sh

      - name: Compress Amplify configuration
        if: steps.configure_rewrites.outcome == 'success'
        shell: bash
        run: |
          tar -czf amplify-config.tar.gz amplify/ lib/amplifyconfiguration.dart
          echo "âœ… Compressed Amplify configuration (amplify/ + lib/amplifyconfiguration.dart)"

      - name: Upload Amplify configuration
        if: steps.configure_rewrites.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: amplify-config-${{ inputs.tenant }}
          path: amplify-config.tar.gz
          retention-days: 7

      - name: Determine status and error
        if: always()
        id: determine_status
        shell: bash
        env:
          INSTALL_AMPLIFY_OUTCOME: ${{ steps.install_amplify_cli.outcome }}
          CONFIGURE_AWS_OUTCOME: ${{ steps.configure_aws.outcome }}
          INIT_AMPLIFY_OUTCOME: ${{ steps.init_amplify.outcome }}
          CREATE_SECRET_OUTCOME: ${{ steps.create_secret.outcome }}
          IMPORT_AUTH_OUTCOME: ${{ steps.import_auth.outcome }}
          CREATE_BRANCH_OUTCOME: ${{ steps.create_amplify_branch.outcome }}
          CONFIGURE_REWRITES_OUTCOME: ${{ steps.configure_rewrites.outcome }}
        run: |
          if [ "$INSTALL_AMPLIFY_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to install Amplify CLI" >> $GITHUB_OUTPUT
          elif [ "$CONFIGURE_AWS_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to configure AWS credentials" >> $GITHUB_OUTPUT
          elif [ "$INIT_AMPLIFY_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to initialize Amplify app" >> $GITHUB_OUTPUT
          elif [ "$CREATE_SECRET_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to create AMPLIFY_APP_ID secret" >> $GITHUB_OUTPUT
          elif [ "$IMPORT_AUTH_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to import Cognito authentication" >> $GITHUB_OUTPUT
          elif [ "$CREATE_BRANCH_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to create Amplify branch" >> $GITHUB_OUTPUT
          elif [ "$CONFIGURE_REWRITES_OUTCOME" != "success" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Failed to configure SPA rewrites" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "error=" >> $GITHUB_OUTPUT
          fi

      - name: Save status with composite action
        if: always()
        uses: ./.github/actions/save-tenant-status
        with:
          tenant: ${{ inputs.tenant }}
          phase: 'amplify-init'
          status: ${{ steps.determine_status.outputs.status }}
          error: ${{ steps.determine_status.outputs.error }}

      - name: Set final status for job output
        if: always()
        id: final_status
        run: echo "status=${{ steps.determine_status.outputs.status }}" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: DEPLOY PORTAL (CALLS REUSABLE WORKFLOW)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-portal:
    name: Deploy Portal
    needs: [validate-config, amplify-init]
    if: inputs.dry_run != true && needs.validate-config.outputs.status == 'success' && needs.amplify-init.outputs.status == 'success'
    uses: ./.github/workflows/_portal-deploy.yml
    with:
      context: ${{ inputs.tenant }}
      amplify_config_artifact: amplify-config-${{ inputs.tenant }}
      save_status: true
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: DEPLOY POS (CALLS REUSABLE WORKFLOW)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pos:
    name: Deploy POS
    needs: [validate-config, amplify-init]
    if: inputs.dry_run != true && needs.validate-config.outputs.status == 'success' && needs.amplify-init.outputs.status == 'success'
    uses: ./.github/workflows/_pos-deploy.yml
    with:
      context: ${{ inputs.tenant }}
      amplify_config_artifact: amplify-config-${{ inputs.tenant }}
      save_status: true
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: TENANT REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tenant-report:
    name: Report
    runs-on: ubuntu-latest
    needs: [validate-config, amplify-init, deploy-portal, deploy-pos]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Download all status artifacts for this tenant
        uses: actions/download-artifact@v4
        with:
          pattern: status-*-${{ inputs.tenant }}
          path: status-reports
          merge-multiple: true

      - name: Generate tenant summary
        shell: bash
        run: |
          # Extract tenant name without "tenant-" prefix
          TENANT_DISPLAY=$(echo "${{ inputs.tenant }}" | sed 's/^tenant-//')
          echo "## Tenant: $TENANT_DISPLAY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Phase results table
          echo "### Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status | Error/Remarks |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------------|" >> $GITHUB_STEP_SUMMARY

          # Define phase names mapping (id -> display name)
          declare -A PHASE_NAMES
          PHASE_NAMES["validation"]="Validation"
          PHASE_NAMES["amplify-init"]="Amplify Init"
          PHASE_NAMES["portal-deploy"]="Portal Deploy"
          PHASE_NAMES["pos-deploy"]="POS Deploy"

          # Process each phase
          for phase in validation amplify-init portal-deploy pos-deploy; do
            FILE="status-reports/${{ inputs.tenant }}-${phase}.json"
            PHASE_DISPLAY="${PHASE_NAMES[$phase]}"

            if [ -f "$FILE" ]; then
              STATUS=$(jq -r '.status' "$FILE")
              ERROR=$(jq -r '.error // ""' "$FILE")

              # Capitalize status
              STATUS_DISPLAY=$(echo "$STATUS" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')

              # Status icon
              if [ "$STATUS" == "success" ]; then
                ICON="âœ…"
              elif [ "$STATUS" == "skipped" ]; then
                ICON="â­ï¸"
              else
                ICON="âŒ"
              fi

              # Format error - show full message
              if [ -n "$ERROR" ]; then
                ERROR_DISPLAY="$ERROR"
              else
                ERROR_DISPLAY="-"
              fi

              echo "| $PHASE_DISPLAY | $ICON $STATUS_DISPLAY | $ERROR_DISPLAY |" >> $GITHUB_STEP_SUMMARY
            else
              # Missing file - if dry run, mark as skipped; otherwise missing
              if [ "${{ inputs.dry_run }}" == "true" ]; then
                echo "| $PHASE_DISPLAY | â­ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $PHASE_DISPLAY | âš ï¸ Missing | No status file |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Resource links section (no heading, only show if links exist)
          HAS_RESOURCES=false
          RESOURCE_OUTPUT=""

          # Define key name mapping (json key -> display name)
          declare -A RESOURCE_NAMES
          RESOURCE_NAMES["portal_url"]="Portal URL"
          RESOURCE_NAMES["release_url"]="POS Installer"

          for phase in validation amplify-init portal-deploy pos-deploy; do
            FILE="status-reports/${{ inputs.tenant }}-${phase}.json"
            if [ -f "$FILE" ]; then
              RESOURCES=$(jq -r '.resources // {}' "$FILE")
              if [ "$RESOURCES" != "{}" ]; then
                HAS_RESOURCES=true
                # Process each resource with custom display names
                while IFS= read -r line; do
                  KEY=$(echo "$line" | jq -r '.key')
                  VALUE=$(echo "$line" | jq -r '.value')
                  DISPLAY_NAME="${RESOURCE_NAMES[$KEY]:-$KEY}"
                  RESOURCE_OUTPUT+="**${DISPLAY_NAME}**: ${VALUE}\n"
                done < <(echo "$RESOURCES" | jq -c 'to_entries[]')
              fi
            fi
          done

          # Only display resources if they exist
          if [ "$HAS_RESOURCES" = true ]; then
            echo -e "$RESOURCE_OUTPUT" >> $GITHUB_STEP_SUMMARY
          fi
