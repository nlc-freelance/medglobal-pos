name: "üîÑ Tenant Deploy"

on:
  workflow_dispatch:
    inputs:
      tenants:
        description: 'Tenant names (comma-separated, e.g., "tenant-hospital-a,tenant-clinic-b") or "all" for all tenants'
        required: true
        default: 'all'
  push:
    branches:
      - main
      - dev
    paths:
      - 'lib/**'
      - 'windows/**'
      - 'web/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'

concurrency:
  group: tenant-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write  # For creating GitHub releases (desktop)
  id-token: write  # For AWS OIDC

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 1: DISCOVER TENANTS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  discover-tenants:
    name: Discover Tenants
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tenants: ${{ steps.discover.outputs.tenants }}
      tenant_count: ${{ steps.count.outputs.tenant_count }}

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Discover tenant environments
        id: discover
        run: |
          # For workflow_dispatch, use input parameter
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            bash .github/scripts/tenants/discover_tenants.sh "${{ github.repository }}" "${{ github.event.inputs.tenants }}"
          else
            # For push events, deploy to all existing tenants
            bash .github/scripts/tenants/discover_tenants.sh "${{ github.repository }}" "all"
          fi

      - name: Calculate tenant count
        id: count
        run: |
          TENANT_COUNT=$(echo '${{ steps.discover.outputs.tenants }}' | jq 'length')
          echo "tenant_count=$TENANT_COUNT" >> $GITHUB_OUTPUT
          echo "Found $TENANT_COUNT tenant(s) to process"

      - name: Summary
        run: |
          echo "## üîÑ Tenant Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tenants found:** ${{ steps.count.outputs.tenant_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tenants to deploy:**" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.discover.outputs.tenants }}' | jq -r '.[] | "- " + .' >> $GITHUB_STEP_SUMMARY

      - name: Exit if no tenants to process
        if: fromJson(steps.count.outputs.tenant_count) == 0
        run: |
          echo "‚ö†Ô∏è No tenants to process. Exiting."
          exit 0

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 2: DEPLOY TENANTS (CALLS REUSABLE WORKFLOW)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  deploy-tenants:
    name: Deploy Tenant
    needs: discover-tenants
    if: fromJson(needs.discover-tenants.outputs.tenant_count) > 0
    strategy:
      fail-fast: false
      matrix:
        tenant: ${{ fromJson(needs.discover-tenants.outputs.tenants) }}
      max-parallel: 3
    uses: ./.github/workflows/_tenant-deploy.yml
    with:
      tenant: ${{ matrix.tenant }}
    secrets: inherit

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 3: GENERATE FINAL REPORT
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  final-report:
    name: Final Report
    runs-on: ubuntu-latest
    needs: [discover-tenants, deploy-tenants]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Download all status artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "status-*"
          path: all-status
          merge-multiple: true

      - name: Generate comprehensive report
        shell: bash
        run: |
          echo "# Multi-Tenant Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üéâ Deployment workflow complete!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate statistics
          TOTAL_TENANTS=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0

          # Get unique tenant names
          TENANTS=$(ls all-status/*-validation.json 2>/dev/null | sed 's|all-status/||; s|-validation.json||' | sort -u || echo "")

          if [ -z "$TENANTS" ]; then
            echo "‚ö†Ô∏è No tenant status files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Check deployment status for all tenants
          for TENANT in $TENANTS; do
            TOTAL_TENANTS=$((TOTAL_TENANTS + 1))

            VAL_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-validation.json" 2>/dev/null || echo "unknown")
            AMP_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-amplify-pull.json" 2>/dev/null || echo "unknown")
            POR_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-portal-deploy.json" 2>/dev/null || echo "unknown")
            POS_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-pos-deploy.json" 2>/dev/null || echo "unknown")

            # Determine overall status
            if [ "$VAL_STATUS" == "success" ] && [ "$AMP_STATUS" == "success" ] && [ "$POR_STATUS" == "success" ] && [ "$POS_STATUS" == "success" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done

          # Display metadata
          echo "**Total tenants:** $TOTAL_TENANTS" >> $GITHUB_STEP_SUMMARY
          echo "**Successful:** $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Failed:** $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Determine workflow status
        shell: bash
        run: |
          # Get statistics from files
          TENANTS=$(ls all-status/*-validation.json 2>/dev/null | sed 's|all-status/||; s|-validation.json||' | sort -u || echo "")

          if [ -z "$TENANTS" ]; then
            echo "‚ö†Ô∏è No tenants processed"
            exit 1
          fi

          FAILED_COUNT=0

          # Check if any tenant failed
          for TENANT in $TENANTS; do
            VAL_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-validation.json" 2>/dev/null || echo "unknown")
            AMP_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-amplify-pull.json" 2>/dev/null || echo "unknown")
            POR_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-portal-deploy.json" 2>/dev/null || echo "unknown")
            POS_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-pos-deploy.json" 2>/dev/null || echo "unknown")

            if [ "$VAL_STATUS" != "success" ] || [ "$AMP_STATUS" != "success" ] || [ "$POR_STATUS" != "success" ] || [ "$POS_STATUS" != "success" ]; then
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done

          if [ $FAILED_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è Workflow completed with failures: $FAILED_COUNT tenant(s) failed"
            exit 1
          else
            echo "‚úÖ Workflow successful: All tenants deployed successfully"
            exit 0
          fi
