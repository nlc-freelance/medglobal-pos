name: "üå± Tenant Onboarding v3"

on:
  workflow_dispatch:
    inputs:
      tenants:
        description: 'Tenant names (comma-separated, e.g., "hospital-a,clinic-b") or "all" for all tenants'
        required: true
        default: 'all'
      dry_run:
        description: 'Dry run (validate config only, no deployment)'
        type: boolean
        default: false

concurrency:
  group: tenant-onboarding-v3-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write  # For creating GitHub releases (desktop)
  id-token: write  # For AWS OIDC

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 1: DISCOVER TENANTS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  discover-tenants:
    name: Discover Tenants
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tenants: ${{ steps.discover.outputs.tenants }}
      tenant_count: ${{ steps.count.outputs.tenant_count }}

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Discover tenant environments
        id: discover
        run: bash .github/scripts/tenants/discover_tenants.sh "${{ github.repository }}" "${{ github.event.inputs.tenants }}"

      - name: Calculate tenant count
        id: count
        run: |
          TENANT_COUNT=$(echo '${{ steps.discover.outputs.tenants }}' | jq 'length')
          echo "tenant_count=$TENANT_COUNT" >> $GITHUB_OUTPUT
          echo "Found $TENANT_COUNT tenant(s) to process"

      - name: Summary
        run: |
          echo "## üîç Tenant Discovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ github.event.inputs.dry_run == 'true' && 'üß™ Dry Run' || 'üöÄ Live Deployment' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tenants found:** ${{ steps.count.outputs.tenant_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tenants to process:**" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.discover.outputs.tenants }}' | jq -r '.[] | "- " + .' >> $GITHUB_STEP_SUMMARY

      - name: Exit if no tenants to process
        if: fromJson(steps.count.outputs.tenant_count) == 0
        run: |
          echo "‚ö†Ô∏è No tenants to process. Exiting."
          exit 0

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 2: VALIDATE TENANT CONFIGURATIONS (BATCH)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  validate-configs:
    name: Validate (${{ matrix.tenant }})
    runs-on: ubuntu-latest
    needs: discover-tenants
    if: fromJson(needs.discover-tenants.outputs.tenant_count) > 0
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        tenant: ${{ fromJson(needs.discover-tenants.outputs.tenants) }}
    environment: ${{ matrix.tenant }}

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      INSTALLER_PUBLISHER: ${{ vars.INSTALLER_PUBLISHER }}
      INSTALLER_APP_NAME: ${{ vars.INSTALLER_APP_NAME }}
      INSTALLER_SUPPORT_URL: ${{ vars.INSTALLER_SUPPORT_URL }}
      AWS_IAM_ROLE_ARN: ${{ vars.AWS_IAM_ROLE_ARN }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      BASE_URL: ${{ vars.BASE_URL }}
      TENANT_NAME: ${{ vars.TENANT_NAME }}
      COGNITO_POOL_ID: ${{ secrets.COGNITO_POOL_ID }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate tenant configuration
        id: validate
        run: bash .github/scripts/tenants/validate_tenant_config.sh "${{ matrix.tenant }}" "onboarding"

      - name: Save validation status
        if: always()
        uses: ./.github/actions/save-tenant-status
        with:
          tenant: ${{ matrix.tenant }}
          phase: 'validation'
          status: ${{ steps.validate.outcome == 'success' && 'success' || 'failed' }}
          error: ${{ steps.validate.outcome != 'success' && 'Configuration validation failed' || '' }}
          config_snapshot: |
            {
              "AWS_REGION": "${{ env.AWS_REGION }}",
              "BASE_URL": "${{ env.BASE_URL }}",
              "TENANT_NAME": "${{ env.TENANT_NAME }}"
            }

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 3: DEPLOY TENANTS (CALLS REUSABLE WORKFLOW)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  deploy-tenants:
    name: Deploy Tenant
    needs: [discover-tenants, validate-configs]
    if: fromJson(needs.discover-tenants.outputs.tenant_count) > 0 && github.event.inputs.dry_run != 'true'
    strategy:
      fail-fast: false
      matrix:
        tenant: ${{ fromJson(needs.discover-tenants.outputs.tenants) }}
      max-parallel: 3
    uses: ./.github/workflows/_tenant-deploy-pipeline.yml
    with:
      tenant: ${{ matrix.tenant }}
      dry_run: false
    secrets: inherit

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 4: GENERATE FINAL REPORT
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  final-report:
    name: Final Report
    runs-on: ubuntu-latest
    needs: [discover-tenants, validate-configs, deploy-tenants]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Download all status artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "status-*"
          path: all-status
          merge-multiple: true

      - name: Generate comprehensive report
        shell: bash
        run: |
          echo "# Multi-Tenant Onboarding" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üéâ Onboarding workflow complete!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate statistics
          TOTAL_TENANTS=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0

          # Get unique tenant names
          TENANTS=$(ls all-status/*-validation.json 2>/dev/null | sed 's|all-status/||; s|-validation.json||' | sort -u || echo "")

          if [ -z "$TENANTS" ]; then
            echo "‚ö†Ô∏è No tenant status files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # For dry run, check validation only
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            for TENANT in $TENANTS; do
              TOTAL_TENANTS=$((TOTAL_TENANTS + 1))

              VAL_FILE="all-status/${TENANT}-validation.json"
              if [ -f "$VAL_FILE" ]; then
                VAL_STATUS=$(jq -r '.status' "$VAL_FILE")

                if [ "$VAL_STATUS" == "success" ]; then
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi
              else
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            done

            # Display dry run metadata
            echo "**Mode:** üß™ Dry Run" >> $GITHUB_STEP_SUMMARY
            echo "**Total tenants:** $TOTAL_TENANTS" >> $GITHUB_STEP_SUMMARY
            echo "**Successful:** $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**Failed:** $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This was a dry-run execution. Only pre-flight checks were performed to validate tenant configurations. No actual deployments were made." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To proceed with full onboarding, re-run the workflow with mode: \`live-deployment\`." >> $GITHUB_STEP_SUMMARY
          else
            # Live deployment - check all phases
            for TENANT in $TENANTS; do
              TOTAL_TENANTS=$((TOTAL_TENANTS + 1))

              VAL_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-validation.json" 2>/dev/null || echo "unknown")
              AMP_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-amplify-init.json" 2>/dev/null || echo "unknown")
              POR_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-portal-deploy.json" 2>/dev/null || echo "unknown")
              POS_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-pos-deploy.json" 2>/dev/null || echo "unknown")

              # Determine overall status
              if [ "$VAL_STATUS" == "success" ] && [ "$AMP_STATUS" == "success" ] && [ "$POR_STATUS" == "success" ] && [ "$POS_STATUS" == "success" ]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            done

            # Display live mode metadata
            echo "**Mode:** üöÄ Live Deployment" >> $GITHUB_STEP_SUMMARY
            echo "**Total tenants:** $TOTAL_TENANTS" >> $GITHUB_STEP_SUMMARY
            echo "**Successful:** $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**Failed:** $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          # Create JSON summary for next retry
          cat > summary.json <<EOF
          {
            "workflow_run": "${{ github.run_id }}",
            "mode": "${{ github.event.inputs.dry_run == 'true' && 'dry_run' || 'live' }}",
            "total_tenants": $TOTAL_TENANTS,
            "successful": $SUCCESS_COUNT,
            "failed": $FAILED_COUNT,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "tenants": [
          EOF

          FIRST=true
          for TENANT in $TENANTS; do
            if [ "$FIRST" == "true" ]; then
              FIRST=false
            else
              echo "," >> summary.json
            fi

            OVERALL_STATUS="${TENANT_DATA[$TENANT]}"
            cat >> summary.json <<EOF
            {
              "name": "$TENANT",
              "overall_status": "$OVERALL_STATUS"
            }
          EOF
          done

          cat >> summary.json <<EOF
            ]
          }
          EOF

      - name: Upload final report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: summary.json
          retention-days: 30

      - name: Determine workflow status
        shell: bash
        run: |
          # Get statistics from files
          TENANTS=$(ls all-status/*-validation.json 2>/dev/null | sed 's|all-status/||; s|-validation.json||' | sort -u || echo "")

          if [ -z "$TENANTS" ]; then
            echo "‚ö†Ô∏è No tenants processed"
            exit 1
          fi

          FAILED_COUNT=0

          # For dry run, check validation only
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            for TENANT in $TENANTS; do
              VAL_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-validation.json" 2>/dev/null || echo "unknown")
              if [ "$VAL_STATUS" != "success" ]; then
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            done

            if [ $FAILED_COUNT -gt 0 ]; then
              echo "‚ùå Workflow failed: $FAILED_COUNT tenant(s) have invalid configuration"
              exit 1
            else
              echo "‚úÖ Workflow successful: All tenant configurations are valid"
              exit 0
            fi
          fi

          # For live deployment, check if any tenant failed
          for TENANT in $TENANTS; do
            VAL_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-validation.json" 2>/dev/null || echo "unknown")
            AMP_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-amplify-init.json" 2>/dev/null || echo "unknown")
            POR_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-portal-deploy.json" 2>/dev/null || echo "unknown")
            POS_STATUS=$(jq -r '.status // "unknown"' "all-status/${TENANT}-pos-deploy.json" 2>/dev/null || echo "unknown")

            if [ "$VAL_STATUS" != "success" ] || [ "$AMP_STATUS" != "success" ] || [ "$POR_STATUS" != "success" ] || [ "$POS_STATUS" != "success" ]; then
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done

          if [ $FAILED_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è Workflow completed with failures: $FAILED_COUNT tenant(s) failed"
            exit 1
          else
            echo "‚úÖ Workflow successful: All tenants deployed successfully"
            exit 0
          fi
